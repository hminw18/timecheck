<!DOCTYPE html>
<html>
<head>
  <title>encryption.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "functions\\encryption.js";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>encryption.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);
<span class="hljs-keyword">const</span> functions = <span class="hljs-built_in">require</span>(<span class="hljs-string">'firebase-functions'</span>);
<span class="hljs-keyword">const</span> secretManager = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./secretManager'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Optimized encryption configuration for production</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">const</span> ALGORITHM = <span class="hljs-string">'aes-256-gcm'</span>;
<span class="hljs-keyword">const</span> SALT_LENGTH = <span class="hljs-number">16</span>; <span class="hljs-comment">// Reduced from 32 for better performance</span>
<span class="hljs-keyword">const</span> TAG_LENGTH = <span class="hljs-number">16</span>;
<span class="hljs-keyword">const</span> KEY_ITERATIONS = <span class="hljs-number">1000</span>; <span class="hljs-comment">// Further reduced for better performance while maintaining security</span>
<span class="hljs-keyword">const</span> KEY_LENGTH = <span class="hljs-number">32</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecureEncryption</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.masterKey = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.keyCache = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>(); <span class="hljs-comment">// Cache derived keys for performance</span>
    <span class="hljs-keyword">this</span>.cacheTimeout = <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>; <span class="hljs-comment">// 5 minutes cache</span>
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Get or derive the master key (cached for entire process lifetime)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">async</span> getMasterKey() {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.masterKey) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Get from Secret Manager only - no fallbacks for production</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">const</span> SECRET_KEY = <span class="hljs-keyword">await</span> secretManager.getSecret(<span class="hljs-string">'encryption-key'</span>);
      
      <span class="hljs-keyword">if</span> (!SECRET_KEY || SECRET_KEY.length &lt; <span class="hljs-number">32</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Encryption key must be configured in Secret Manager'</span>);
      }
      
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>For production, use the secret directly as the master key (already 32+ bytes)
This avoids PBKDF2 overhead since Secret Manager already provides secure random keys</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">this</span>.masterKey = Buffer.from(SECRET_KEY.slice(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>), <span class="hljs-string">'utf8'</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.masterKey;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Encrypt data with AES-256-GCM (provides both confidentiality and authenticity)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">async</span> encrypt(plaintext, additionalData = <span class="hljs-string">''</span>) {
    <span class="hljs-keyword">if</span> (!plaintext) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Plaintext cannot be empty'</span>);
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Generate random salt and IV for each encryption</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> salt = crypto.randomBytes(SALT_LENGTH);
    <span class="hljs-keyword">const</span> iv = crypto.randomBytes(<span class="hljs-number">16</span>);
    
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Derive a unique key for this encryption using the salt
Check cache first for performance</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> cacheKey = <span class="hljs-string">`<span class="hljs-subst">${salt.toString(<span class="hljs-string">'base64'</span>).substring(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>)}</span>-<span class="hljs-subst">${additionalData}</span>`</span>;
    <span class="hljs-keyword">let</span> key = <span class="hljs-keyword">this</span>.keyCache.get(cacheKey);
    
    <span class="hljs-keyword">if</span> (!key) {
      <span class="hljs-keyword">const</span> masterKey = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getMasterKey();
      key = crypto.pbkdf2Sync(
        masterKey, 
        salt, 
        KEY_ITERATIONS,
        KEY_LENGTH, 
        <span class="hljs-string">'sha256'</span>
      );
      
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Cache the key with expiry</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">this</span>.keyCache.set(cacheKey, key);
      setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">this</span>.keyCache.delete(cacheKey), <span class="hljs-keyword">this</span>.cacheTimeout);
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Create cipher</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> cipher = crypto.createCipheriv(ALGORITHM, key, iv);
    
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>Add additional authenticated data (AAD) if provided</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (additionalData) {
      cipher.setAAD(Buffer.from(additionalData), { <span class="hljs-attr">plaintextLength</span>: Buffer.byteLength(plaintext) });
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Encrypt the data</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">let</span> encrypted = cipher.update(plaintext, <span class="hljs-string">'utf8'</span>, <span class="hljs-string">'base64'</span>);
    encrypted += cipher.final(<span class="hljs-string">'base64'</span>);
    
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>Get the authentication tag</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> authTag = cipher.getAuthTag();

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Combine all components into a single string
Format: salt:iv:authTag:encrypted:additionalData</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> combined = [
      salt.toString(<span class="hljs-string">'base64'</span>),
      iv.toString(<span class="hljs-string">'base64'</span>),
      authTag.toString(<span class="hljs-string">'base64'</span>),
      encrypted,
      Buffer.from(additionalData).toString(<span class="hljs-string">'base64'</span>)
    ].join(<span class="hljs-string">':'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>Skip HMAC for performance - GCM already provides authentication
This removes the double authentication overhead</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">return</span> combined;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>Decrypt data</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">async</span> decrypt(encryptedData) {
    <span class="hljs-keyword">if</span> (!encryptedData || <span class="hljs-keyword">typeof</span> encryptedData !== <span class="hljs-string">'string'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid encrypted data'</span>);
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>Handle both old format (with HMAC) and new format (without)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">let</span> combined;
    <span class="hljs-keyword">if</span> (encryptedData.includes(<span class="hljs-string">'$'</span>)) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>Old format with HMAC</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">const</span> [signature, data] = encryptedData.split(<span class="hljs-string">'$'</span>);
      <span class="hljs-keyword">const</span> masterKey = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getMasterKey();
      <span class="hljs-keyword">const</span> hmac = crypto.createHmac(<span class="hljs-string">'sha256'</span>, masterKey);
      hmac.update(data);
      <span class="hljs-keyword">const</span> expectedSignature = hmac.digest(<span class="hljs-string">'base64'</span>);
      
      <span class="hljs-keyword">if</span> (!crypto.timingSafeEqual(Buffer.from(signature), Buffer.from(expectedSignature))) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Data integrity check failed'</span>);
      }
      combined = data;
    } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>New format without HMAC (GCM provides authentication)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      combined = encryptedData;
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>Parse components</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> [saltB64, ivB64, authTagB64, encrypted, additionalDataB64] = combined.split(<span class="hljs-string">':'</span>);
    <span class="hljs-keyword">if</span> (!saltB64 || !ivB64 || !authTagB64 || !encrypted) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Invalid encrypted data components'</span>);
    }

    <span class="hljs-keyword">const</span> salt = Buffer.from(saltB64, <span class="hljs-string">'base64'</span>);
    <span class="hljs-keyword">const</span> iv = Buffer.from(ivB64, <span class="hljs-string">'base64'</span>);
    <span class="hljs-keyword">const</span> authTag = Buffer.from(authTagB64, <span class="hljs-string">'base64'</span>);
    <span class="hljs-keyword">const</span> additionalData = additionalDataB64 ? Buffer.from(additionalDataB64, <span class="hljs-string">'base64'</span>).toString() : <span class="hljs-string">''</span>;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>Derive the key using the salt
Check cache first for performance</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> cacheKey = <span class="hljs-string">`<span class="hljs-subst">${salt.toString(<span class="hljs-string">'base64'</span>).substring(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>)}</span>-<span class="hljs-subst">${additionalData}</span>`</span>;
    <span class="hljs-keyword">let</span> key = <span class="hljs-keyword">this</span>.keyCache.get(cacheKey);
    
    <span class="hljs-keyword">if</span> (!key) {
      <span class="hljs-keyword">const</span> masterKey = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.getMasterKey();
      key = crypto.pbkdf2Sync(
        masterKey, 
        salt, 
        KEY_ITERATIONS,
        KEY_LENGTH, 
        <span class="hljs-string">'sha256'</span>
      );
      
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>Cache the key with expiry</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">this</span>.keyCache.set(cacheKey, key);
      setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">this</span>.keyCache.delete(cacheKey), <span class="hljs-keyword">this</span>.cacheTimeout);
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>Create decipher</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">const</span> decipher = crypto.createDecipheriv(ALGORITHM, key, iv);
    decipher.setAuthTag(authTag);
    
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>Set AAD if it was used</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (additionalData) {
      decipher.setAAD(Buffer.from(additionalData));
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>Decrypt the data</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">let</span> decrypted = decipher.update(encrypted, <span class="hljs-string">'base64'</span>, <span class="hljs-string">'utf8'</span>);
    decrypted += decipher.final(<span class="hljs-string">'utf8'</span>);

    <span class="hljs-keyword">return</span> decrypted;
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>Encrypt sensitive data with additional context</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">async</span> encryptCredentials(credentials, userId) {
    <span class="hljs-keyword">const</span> data = <span class="hljs-built_in">JSON</span>.stringify(credentials);
    <span class="hljs-keyword">const</span> context = <span class="hljs-string">`user:<span class="hljs-subst">${userId}</span>:timestamp:<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.encrypt(data, context);
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>Decrypt credentials</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">async</span> decryptCredentials(encryptedData, userId) {
    <span class="hljs-keyword">const</span> decrypted = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.decrypt(encryptedData);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(decrypted);
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>Generate a secure random token</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  generateSecureToken(length = <span class="hljs-number">32</span>) {
    <span class="hljs-keyword">return</span> crypto.randomBytes(length).toString(<span class="hljs-string">'base64url'</span>);
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>Hash passwords (for any password-like data)</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">async</span> hashPassword(password) {
    <span class="hljs-keyword">const</span> salt = crypto.randomBytes(<span class="hljs-number">16</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      crypto.pbkdf2(password, salt, <span class="hljs-number">10000</span>, <span class="hljs-number">64</span>, <span class="hljs-string">'sha256'</span>, (err, derivedKey) =&gt; {
        <span class="hljs-keyword">if</span> (err) reject(err);
        resolve(<span class="hljs-string">`<span class="hljs-subst">${salt.toString(<span class="hljs-string">'hex'</span>)}</span>:<span class="hljs-subst">${derivedKey.toString(<span class="hljs-string">'hex'</span>)}</span>`</span>);
      });
    });
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>Verify password</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">async</span> verifyPassword(password, hash) {
    <span class="hljs-keyword">const</span> [salt, key] = hash.split(<span class="hljs-string">':'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      crypto.pbkdf2(password, Buffer.from(salt, <span class="hljs-string">'hex'</span>), <span class="hljs-number">10000</span>, <span class="hljs-number">64</span>, <span class="hljs-string">'sha256'</span>, (err, derivedKey) =&gt; {
        <span class="hljs-keyword">if</span> (err) reject(err);
        resolve(crypto.timingSafeEqual(Buffer.from(key, <span class="hljs-string">'hex'</span>), derivedKey));
      });
    });
  }
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>Export singleton instance</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">new</span> SecureEncryption();
</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
