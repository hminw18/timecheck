<!DOCTYPE html>
<html>
<head>
  <title>SECRET_MANAGER_GUIDE.md</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "functions\\SECRET_MANAGER_GUIDE.md";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#google-secret-manager">🔐 Google Secret Manager 설정 가이드</a>
      </div>

      <div class="heading h2">
        <a href="#1.secret-manager">1. Secret Manager 활성화</a>
      </div>

      <div class="heading h2">
        <a href="#2.">2. 시크릿 생성</a>
      </div>

      <div class="heading h2">
        <a href="#3.firebase-functions">3. Firebase Functions에 권한 부여</a>
      </div>

      <div class="heading h2">
        <a href="#4.functions">4. Functions 코드 업데이트</a>
      </div>

      <div class="heading h3">
        <a href="#functionssecretmanager.js">functions/secretManager.js</a>
      </div>

      <div class="heading h3">
        <a href="#functionsindex.js">functions/index.js 업데이트</a>
      </div>

      <div class="heading h2">
        <a href="#5.package.json">5. package.json 업데이트</a>
      </div>

      <div class="heading h2">
        <a href="#6.">6. 로컬 개발 환경 설정</a>
      </div>

      <div class="heading h3">
        <a href="#.env.local">.env.local (개발용)</a>
      </div>

      <div class="heading h3">
        <a href="#">로컬 서비스 계정 설정</a>
      </div>

      <div class="heading h2">
        <a href="#7.">7. 배포 시 환경 변수 제거</a>
      </div>

      <div class="heading h2">
        <a href="#8.">8. 시크릿 로테이션</a>
      </div>

      <div class="heading h2">
        <a href="#-1">🎯 장점</a>
      </div>

      <div class="heading h2">
        <a href="#warning">⚠️ 주의사항</a>
      </div>

      <div class="heading h2">
        <a href="#-2">📊 비용 최적화</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="docs markdown"><div class="pilwrap" id="google-secret-manager">
  <h1>
    <a href="#google-secret-manager" name="google-secret-manager" class="pilcrow"></a>
🔐 Google Secret Manager 설정 가이드
  </h1>
</div>
<div class="pilwrap" id="1.secret-manager">
  <h2>
    <a href="#1.secret-manager" name="1.secret-manager" class="pilcrow"></a>
1. Secret Manager 활성화
  </h2>
</div>
<pre><code class="bash"><span class="hljs-comment"># Secret Manager API 활성화</span>
gcloud services <span class="hljs-built_in">enable</span> secretmanager.googleapis.com

<span class="hljs-comment"># 프로젝트 확인</span>
gcloud config get-value project
</code></pre>
<div class="pilwrap" id="2.">
  <h2>
    <a href="#2." name="2." class="pilcrow"></a>
2. 시크릿 생성
  </h2>
</div>
<pre><code class="bash"><span class="hljs-comment"># 암호화 키 생성 및 저장</span>
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"your-super-secret-encryption-key-here"</span> | gcloud secrets create encryption-key --data-file=-

<span class="hljs-comment"># Google OAuth 클라이언트 시크릿</span>
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"your-google-client-secret"</span> | gcloud secrets create google-client-secret --data-file=-

<span class="hljs-comment"># 기타 민감한 정보들</span>
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"your-apple-app-password"</span> | gcloud secrets create apple-app-password --data-file=-
</code></pre>
<div class="pilwrap" id="3.firebase-functions">
  <h2>
    <a href="#3.firebase-functions" name="3.firebase-functions" class="pilcrow"></a>
3. Firebase Functions에 권한 부여
  </h2>
</div>
<pre><code class="bash"><span class="hljs-comment"># Functions 서비스 계정 찾기</span>
gcloud projects get-iam-policy YOUR_PROJECT_ID

<span class="hljs-comment"># Secret Manager 접근 권한 부여</span>
gcloud secrets add-iam-policy-binding encryption-key \
  --member=<span class="hljs-string">"serviceAccount:YOUR_PROJECT_ID@appspot.gserviceaccount.com"</span> \
  --role=<span class="hljs-string">"roles/secretmanager.secretAccessor"</span>

gcloud secrets add-iam-policy-binding google-client-secret \
  --member=<span class="hljs-string">"serviceAccount:YOUR_PROJECT_ID@appspot.gserviceaccount.com"</span> \
  --role=<span class="hljs-string">"roles/secretmanager.secretAccessor"</span>
</code></pre>
<div class="pilwrap" id="4.functions">
  <h2>
    <a href="#4.functions" name="4.functions" class="pilcrow"></a>
4. Functions 코드 업데이트
  </h2>
</div>
<div class="pilwrap" id="functionssecretmanager.js">
  <h3>
    <a href="#functionssecretmanager.js" name="functionssecretmanager.js" class="pilcrow"></a>
functions/secretManager.js
  </h3>
</div>
<pre><code class="javascript"><span class="hljs-keyword">const</span> {SecretManagerServiceClient} = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@google-cloud/secret-manager'</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecretManager</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.client = <span class="hljs-keyword">new</span> SecretManagerServiceClient();
    <span class="hljs-keyword">this</span>.projectId = process.env.GCLOUD_PROJECT || process.env.GCP_PROJECT;
    <span class="hljs-keyword">this</span>.cache = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();
  }

  <span class="hljs-keyword">async</span> getSecret(secretName) {
    <span class="hljs-comment">// Check cache first</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cache.has(secretName)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cache.get(secretName);
    }

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> name = <span class="hljs-string">`projects/<span class="hljs-subst">${<span class="hljs-keyword">this</span>.projectId}</span>/secrets/<span class="hljs-subst">${secretName}</span>/versions/latest`</span>;
      <span class="hljs-keyword">const</span> [version] = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.client.accessSecretVersion({name});
      <span class="hljs-keyword">const</span> payload = version.payload.data.toString(<span class="hljs-string">'utf8'</span>);
      
      <span class="hljs-comment">// Cache for 1 hour</span>
      <span class="hljs-keyword">this</span>.cache.set(secretName, payload);
      setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">this</span>.cache.delete(secretName), <span class="hljs-number">3600000</span>);
      
      <span class="hljs-keyword">return</span> payload;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`Failed to access secret <span class="hljs-subst">${secretName}</span>:`</span>, error);
      <span class="hljs-comment">// Fallback to environment variable</span>
      <span class="hljs-keyword">return</span> process.env[secretName.toUpperCase().replace(<span class="hljs-regexp">/-/g</span>, <span class="hljs-string">'_'</span>)];
    }
  }
}

<span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">new</span> SecretManager();
</code></pre>
<div class="pilwrap" id="functionsindex.js">
  <h3>
    <a href="#functionsindex.js" name="functionsindex.js" class="pilcrow"></a>
functions/index.js 업데이트
  </h3>
</div>
<pre><code class="javascript"><span class="hljs-keyword">const</span> secretManager = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./secretManager'</span>);

<span class="hljs-comment">// 암호화 키 가져오기</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getEncryptionKey</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> secretManager.getSecret(<span class="hljs-string">'encryption-key'</span>);
}

<span class="hljs-comment">// Google 클라이언트 시크릿</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getGoogleClientSecret</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> secretManager.getSecret(<span class="hljs-string">'google-client-secret'</span>);
}

<span class="hljs-comment">// 사용 예시</span>
exports.appleCalendarConnect = functions.https.onCall(<span class="hljs-keyword">async</span> (data, context) =&gt; {
  <span class="hljs-keyword">const</span> encryptionKey = <span class="hljs-keyword">await</span> getEncryptionKey();
  <span class="hljs-comment">// ... 나머지 코드</span>
});
</code></pre>
<div class="pilwrap" id="5.package.json">
  <h2>
    <a href="#5.package.json" name="5.package.json" class="pilcrow"></a>
5. package.json 업데이트
  </h2>
</div>
<pre><code class="json">{
  <span class="hljs-attr">"dependencies"</span>: {
    <span class="hljs-attr">"@google-cloud/secret-manager"</span>: <span class="hljs-string">"^5.0.0"</span>,
    <span class="hljs-comment">// ... 기타 dependencies</span>
  }
}
</code></pre>
<div class="pilwrap" id="6.">
  <h2>
    <a href="#6." name="6." class="pilcrow"></a>
6. 로컬 개발 환경 설정
  </h2>
</div>
<div class="pilwrap" id=".env.local">
  <h3>
    <a href="#.env.local" name=".env.local" class="pilcrow"></a>
.env.local (개발용)
  </h3>
</div>
<pre><code class="bash"><span class="hljs-comment"># 로컬에서는 환경 변수 사용</span>
ENCRYPTION_KEY=<span class="hljs-built_in">local</span>-development-key
GOOGLE_CLIENT_SECRET=<span class="hljs-built_in">local</span>-dev-secret
</code></pre>
<div class="pilwrap" id="">
  <h3>
    <a href="#" name="" class="pilcrow"></a>
로컬 서비스 계정 설정
  </h3>
</div>
<pre><code class="bash"><span class="hljs-comment"># 서비스 계정 키 생성 (개발용만!)</span>
gcloud iam service-accounts keys create key.json \
  --iam-account=YOUR_PROJECT_ID@appspot.gserviceaccount.com

<span class="hljs-comment"># 환경 변수 설정</span>
<span class="hljs-built_in">export</span> GOOGLE_APPLICATION_CREDENTIALS=<span class="hljs-string">"path/to/key.json"</span>
</code></pre>
<div class="pilwrap" id="7.">
  <h2>
    <a href="#7." name="7." class="pilcrow"></a>
7. 배포 시 환경 변수 제거
  </h2>
</div>
<pre><code class="bash"><span class="hljs-comment"># 기존 환경 변수 제거</span>
firebase <span class="hljs-built_in">functions</span>:config:<span class="hljs-built_in">unset</span> encryption.key
firebase <span class="hljs-built_in">functions</span>:config:<span class="hljs-built_in">unset</span> google.client_secret

<span class="hljs-comment"># 배포</span>
firebase deploy --only <span class="hljs-built_in">functions</span>
</code></pre>
<div class="pilwrap" id="8.">
  <h2>
    <a href="#8." name="8." class="pilcrow"></a>
8. 시크릿 로테이션
  </h2>
</div>
<pre><code class="bash"><span class="hljs-comment"># 새 버전 추가</span>
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"new-encryption-key"</span> | gcloud secrets versions add encryption-key --data-file=-

<span class="hljs-comment"># 이전 버전 비활성화</span>
gcloud secrets versions <span class="hljs-built_in">disable</span> 1 --secret=<span class="hljs-string">"encryption-key"</span>
</code></pre>
<div class="pilwrap" id="-1">
  <h2>
    <a href="#-1" name="-1" class="pilcrow"></a>
🎯 장점
  </h2>
</div>
<ol>
<li><strong>중앙 집중식 관리</strong>: 모든 시크릿을 한 곳에서 관리</li>
<li><strong>감사 로깅</strong>: 모든 접근이 기록됨</li>
<li><strong>자동 로테이션</strong>: 버전 관리 및 자동 업데이트</li>
<li><strong>세밀한 권한 제어</strong>: IAM으로 접근 제어</li>
<li><strong>암호화</strong>: Google이 자동으로 암호화/복호화</li>
</ol>
<div class="pilwrap" id="warning">
  <h2>
    <a href="#warning" name="warning" class="pilcrow"></a>
⚠️ 주의사항
  </h2>
</div>
<ol>
<li><strong>비용</strong>: 시크릿 접근마다 소액 과금 (캐싱 필수!)</li>
<li><strong>콜드 스타트</strong>: 첫 접근 시 약간의 지연</li>
<li><strong>서비스 계정</strong>: 올바른 권한 설정 필수</li>
</ol>
<div class="pilwrap" id="-2">
  <h2>
    <a href="#-2" name="-2" class="pilcrow"></a>
📊 비용 최적화
  </h2>
</div>
<ul>
<li>시크릿 스토리지: $0.06/월/시크릿</li>
<li>접근 요청: $0.03/10,000 요청</li>
<li>캐싱으로 비용 최소화 가능</li>
</ul>
<hr>
<p><strong>결론</strong>: Firebase Functions Config보다 Secret Manager가 훨씬 안전하고 관리하기 쉽습니다!</p>
</div>
  </div>
</body>
</html>
