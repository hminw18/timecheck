<!DOCTYPE html>
<html>
<head>
  <title>SECRET_MANAGER_GUIDE.md</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "functions\\SECRET_MANAGER_GUIDE.md";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#google-secret-manager">ğŸ” Google Secret Manager ì„¤ì • ê°€ì´ë“œ</a>
      </div>

      <div class="heading h2">
        <a href="#1.secret-manager">1. Secret Manager í™œì„±í™”</a>
      </div>

      <div class="heading h2">
        <a href="#2.">2. ì‹œí¬ë¦¿ ìƒì„±</a>
      </div>

      <div class="heading h2">
        <a href="#3.firebase-functions">3. Firebase Functionsì— ê¶Œí•œ ë¶€ì—¬</a>
      </div>

      <div class="heading h2">
        <a href="#4.functions">4. Functions ì½”ë“œ ì—…ë°ì´íŠ¸</a>
      </div>

      <div class="heading h3">
        <a href="#functionssecretmanager.js">functions/secretManager.js</a>
      </div>

      <div class="heading h3">
        <a href="#functionsindex.js">functions/index.js ì—…ë°ì´íŠ¸</a>
      </div>

      <div class="heading h2">
        <a href="#5.package.json">5. package.json ì—…ë°ì´íŠ¸</a>
      </div>

      <div class="heading h2">
        <a href="#6.">6. ë¡œì»¬ ê°œë°œ í™˜ê²½ ì„¤ì •</a>
      </div>

      <div class="heading h3">
        <a href="#.env.local">.env.local (ê°œë°œìš©)</a>
      </div>

      <div class="heading h3">
        <a href="#">ë¡œì»¬ ì„œë¹„ìŠ¤ ê³„ì • ì„¤ì •</a>
      </div>

      <div class="heading h2">
        <a href="#7.">7. ë°°í¬ ì‹œ í™˜ê²½ ë³€ìˆ˜ ì œê±°</a>
      </div>

      <div class="heading h2">
        <a href="#8.">8. ì‹œí¬ë¦¿ ë¡œí…Œì´ì…˜</a>
      </div>

      <div class="heading h2">
        <a href="#-1">ğŸ¯ ì¥ì </a>
      </div>

      <div class="heading h2">
        <a href="#warning">âš ï¸ ì£¼ì˜ì‚¬í•­</a>
      </div>

      <div class="heading h2">
        <a href="#-2">ğŸ“Š ë¹„ìš© ìµœì í™”</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="docs markdown"><div class="pilwrap" id="google-secret-manager">
  <h1>
    <a href="#google-secret-manager" name="google-secret-manager" class="pilcrow"></a>
ğŸ” Google Secret Manager ì„¤ì • ê°€ì´ë“œ
  </h1>
</div>
<div class="pilwrap" id="1.secret-manager">
  <h2>
    <a href="#1.secret-manager" name="1.secret-manager" class="pilcrow"></a>
1. Secret Manager í™œì„±í™”
  </h2>
</div>
<pre><code class="bash"><span class="hljs-comment"># Secret Manager API í™œì„±í™”</span>
gcloud services <span class="hljs-built_in">enable</span> secretmanager.googleapis.com

<span class="hljs-comment"># í”„ë¡œì íŠ¸ í™•ì¸</span>
gcloud config get-value project
</code></pre>
<div class="pilwrap" id="2.">
  <h2>
    <a href="#2." name="2." class="pilcrow"></a>
2. ì‹œí¬ë¦¿ ìƒì„±
  </h2>
</div>
<pre><code class="bash"><span class="hljs-comment"># ì•”í˜¸í™” í‚¤ ìƒì„± ë° ì €ì¥</span>
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"your-super-secret-encryption-key-here"</span> | gcloud secrets create encryption-key --data-file=-

<span class="hljs-comment"># Google OAuth í´ë¼ì´ì–¸íŠ¸ ì‹œí¬ë¦¿</span>
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"your-google-client-secret"</span> | gcloud secrets create google-client-secret --data-file=-

<span class="hljs-comment"># ê¸°íƒ€ ë¯¼ê°í•œ ì •ë³´ë“¤</span>
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"your-apple-app-password"</span> | gcloud secrets create apple-app-password --data-file=-
</code></pre>
<div class="pilwrap" id="3.firebase-functions">
  <h2>
    <a href="#3.firebase-functions" name="3.firebase-functions" class="pilcrow"></a>
3. Firebase Functionsì— ê¶Œí•œ ë¶€ì—¬
  </h2>
</div>
<pre><code class="bash"><span class="hljs-comment"># Functions ì„œë¹„ìŠ¤ ê³„ì • ì°¾ê¸°</span>
gcloud projects get-iam-policy YOUR_PROJECT_ID

<span class="hljs-comment"># Secret Manager ì ‘ê·¼ ê¶Œí•œ ë¶€ì—¬</span>
gcloud secrets add-iam-policy-binding encryption-key \
  --member=<span class="hljs-string">"serviceAccount:YOUR_PROJECT_ID@appspot.gserviceaccount.com"</span> \
  --role=<span class="hljs-string">"roles/secretmanager.secretAccessor"</span>

gcloud secrets add-iam-policy-binding google-client-secret \
  --member=<span class="hljs-string">"serviceAccount:YOUR_PROJECT_ID@appspot.gserviceaccount.com"</span> \
  --role=<span class="hljs-string">"roles/secretmanager.secretAccessor"</span>
</code></pre>
<div class="pilwrap" id="4.functions">
  <h2>
    <a href="#4.functions" name="4.functions" class="pilcrow"></a>
4. Functions ì½”ë“œ ì—…ë°ì´íŠ¸
  </h2>
</div>
<div class="pilwrap" id="functionssecretmanager.js">
  <h3>
    <a href="#functionssecretmanager.js" name="functionssecretmanager.js" class="pilcrow"></a>
functions/secretManager.js
  </h3>
</div>
<pre><code class="javascript"><span class="hljs-keyword">const</span> {SecretManagerServiceClient} = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@google-cloud/secret-manager'</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecretManager</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.client = <span class="hljs-keyword">new</span> SecretManagerServiceClient();
    <span class="hljs-keyword">this</span>.projectId = process.env.GCLOUD_PROJECT || process.env.GCP_PROJECT;
    <span class="hljs-keyword">this</span>.cache = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>();
  }

  <span class="hljs-keyword">async</span> getSecret(secretName) {
    <span class="hljs-comment">// Check cache first</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cache.has(secretName)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cache.get(secretName);
    }

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> name = <span class="hljs-string">`projects/<span class="hljs-subst">${<span class="hljs-keyword">this</span>.projectId}</span>/secrets/<span class="hljs-subst">${secretName}</span>/versions/latest`</span>;
      <span class="hljs-keyword">const</span> [version] = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.client.accessSecretVersion({name});
      <span class="hljs-keyword">const</span> payload = version.payload.data.toString(<span class="hljs-string">'utf8'</span>);
      
      <span class="hljs-comment">// Cache for 1 hour</span>
      <span class="hljs-keyword">this</span>.cache.set(secretName, payload);
      setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-keyword">this</span>.cache.delete(secretName), <span class="hljs-number">3600000</span>);
      
      <span class="hljs-keyword">return</span> payload;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`Failed to access secret <span class="hljs-subst">${secretName}</span>:`</span>, error);
      <span class="hljs-comment">// Fallback to environment variable</span>
      <span class="hljs-keyword">return</span> process.env[secretName.toUpperCase().replace(<span class="hljs-regexp">/-/g</span>, <span class="hljs-string">'_'</span>)];
    }
  }
}

<span class="hljs-built_in">module</span>.exports = <span class="hljs-keyword">new</span> SecretManager();
</code></pre>
<div class="pilwrap" id="functionsindex.js">
  <h3>
    <a href="#functionsindex.js" name="functionsindex.js" class="pilcrow"></a>
functions/index.js ì—…ë°ì´íŠ¸
  </h3>
</div>
<pre><code class="javascript"><span class="hljs-keyword">const</span> secretManager = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./secretManager'</span>);

<span class="hljs-comment">// ì•”í˜¸í™” í‚¤ ê°€ì ¸ì˜¤ê¸°</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getEncryptionKey</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> secretManager.getSecret(<span class="hljs-string">'encryption-key'</span>);
}

<span class="hljs-comment">// Google í´ë¼ì´ì–¸íŠ¸ ì‹œí¬ë¦¿</span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getGoogleClientSecret</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> secretManager.getSecret(<span class="hljs-string">'google-client-secret'</span>);
}

<span class="hljs-comment">// ì‚¬ìš© ì˜ˆì‹œ</span>
exports.appleCalendarConnect = functions.https.onCall(<span class="hljs-keyword">async</span> (data, context) =&gt; {
  <span class="hljs-keyword">const</span> encryptionKey = <span class="hljs-keyword">await</span> getEncryptionKey();
  <span class="hljs-comment">// ... ë‚˜ë¨¸ì§€ ì½”ë“œ</span>
});
</code></pre>
<div class="pilwrap" id="5.package.json">
  <h2>
    <a href="#5.package.json" name="5.package.json" class="pilcrow"></a>
5. package.json ì—…ë°ì´íŠ¸
  </h2>
</div>
<pre><code class="json">{
  <span class="hljs-attr">"dependencies"</span>: {
    <span class="hljs-attr">"@google-cloud/secret-manager"</span>: <span class="hljs-string">"^5.0.0"</span>,
    <span class="hljs-comment">// ... ê¸°íƒ€ dependencies</span>
  }
}
</code></pre>
<div class="pilwrap" id="6.">
  <h2>
    <a href="#6." name="6." class="pilcrow"></a>
6. ë¡œì»¬ ê°œë°œ í™˜ê²½ ì„¤ì •
  </h2>
</div>
<div class="pilwrap" id=".env.local">
  <h3>
    <a href="#.env.local" name=".env.local" class="pilcrow"></a>
.env.local (ê°œë°œìš©)
  </h3>
</div>
<pre><code class="bash"><span class="hljs-comment"># ë¡œì»¬ì—ì„œëŠ” í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©</span>
ENCRYPTION_KEY=<span class="hljs-built_in">local</span>-development-key
GOOGLE_CLIENT_SECRET=<span class="hljs-built_in">local</span>-dev-secret
</code></pre>
<div class="pilwrap" id="">
  <h3>
    <a href="#" name="" class="pilcrow"></a>
ë¡œì»¬ ì„œë¹„ìŠ¤ ê³„ì • ì„¤ì •
  </h3>
</div>
<pre><code class="bash"><span class="hljs-comment"># ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ìƒì„± (ê°œë°œìš©ë§Œ!)</span>
gcloud iam service-accounts keys create key.json \
  --iam-account=YOUR_PROJECT_ID@appspot.gserviceaccount.com

<span class="hljs-comment"># í™˜ê²½ ë³€ìˆ˜ ì„¤ì •</span>
<span class="hljs-built_in">export</span> GOOGLE_APPLICATION_CREDENTIALS=<span class="hljs-string">"path/to/key.json"</span>
</code></pre>
<div class="pilwrap" id="7.">
  <h2>
    <a href="#7." name="7." class="pilcrow"></a>
7. ë°°í¬ ì‹œ í™˜ê²½ ë³€ìˆ˜ ì œê±°
  </h2>
</div>
<pre><code class="bash"><span class="hljs-comment"># ê¸°ì¡´ í™˜ê²½ ë³€ìˆ˜ ì œê±°</span>
firebase <span class="hljs-built_in">functions</span>:config:<span class="hljs-built_in">unset</span> encryption.key
firebase <span class="hljs-built_in">functions</span>:config:<span class="hljs-built_in">unset</span> google.client_secret

<span class="hljs-comment"># ë°°í¬</span>
firebase deploy --only <span class="hljs-built_in">functions</span>
</code></pre>
<div class="pilwrap" id="8.">
  <h2>
    <a href="#8." name="8." class="pilcrow"></a>
8. ì‹œí¬ë¦¿ ë¡œí…Œì´ì…˜
  </h2>
</div>
<pre><code class="bash"><span class="hljs-comment"># ìƒˆ ë²„ì „ ì¶”ê°€</span>
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"new-encryption-key"</span> | gcloud secrets versions add encryption-key --data-file=-

<span class="hljs-comment"># ì´ì „ ë²„ì „ ë¹„í™œì„±í™”</span>
gcloud secrets versions <span class="hljs-built_in">disable</span> 1 --secret=<span class="hljs-string">"encryption-key"</span>
</code></pre>
<div class="pilwrap" id="-1">
  <h2>
    <a href="#-1" name="-1" class="pilcrow"></a>
ğŸ¯ ì¥ì 
  </h2>
</div>
<ol>
<li><strong>ì¤‘ì•™ ì§‘ì¤‘ì‹ ê´€ë¦¬</strong>: ëª¨ë“  ì‹œí¬ë¦¿ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬</li>
<li><strong>ê°ì‚¬ ë¡œê¹…</strong>: ëª¨ë“  ì ‘ê·¼ì´ ê¸°ë¡ë¨</li>
<li><strong>ìë™ ë¡œí…Œì´ì…˜</strong>: ë²„ì „ ê´€ë¦¬ ë° ìë™ ì—…ë°ì´íŠ¸</li>
<li><strong>ì„¸ë°€í•œ ê¶Œí•œ ì œì–´</strong>: IAMìœ¼ë¡œ ì ‘ê·¼ ì œì–´</li>
<li><strong>ì•”í˜¸í™”</strong>: Googleì´ ìë™ìœ¼ë¡œ ì•”í˜¸í™”/ë³µí˜¸í™”</li>
</ol>
<div class="pilwrap" id="warning">
  <h2>
    <a href="#warning" name="warning" class="pilcrow"></a>
âš ï¸ ì£¼ì˜ì‚¬í•­
  </h2>
</div>
<ol>
<li><strong>ë¹„ìš©</strong>: ì‹œí¬ë¦¿ ì ‘ê·¼ë§ˆë‹¤ ì†Œì•¡ ê³¼ê¸ˆ (ìºì‹± í•„ìˆ˜!)</li>
<li><strong>ì½œë“œ ìŠ¤íƒ€íŠ¸</strong>: ì²« ì ‘ê·¼ ì‹œ ì•½ê°„ì˜ ì§€ì—°</li>
<li><strong>ì„œë¹„ìŠ¤ ê³„ì •</strong>: ì˜¬ë°”ë¥¸ ê¶Œí•œ ì„¤ì • í•„ìˆ˜</li>
</ol>
<div class="pilwrap" id="-2">
  <h2>
    <a href="#-2" name="-2" class="pilcrow"></a>
ğŸ“Š ë¹„ìš© ìµœì í™”
  </h2>
</div>
<ul>
<li>ì‹œí¬ë¦¿ ìŠ¤í† ë¦¬ì§€: $0.06/ì›”/ì‹œí¬ë¦¿</li>
<li>ì ‘ê·¼ ìš”ì²­: $0.03/10,000 ìš”ì²­</li>
<li>ìºì‹±ìœ¼ë¡œ ë¹„ìš© ìµœì†Œí™” ê°€ëŠ¥</li>
</ul>
<hr>
<p><strong>ê²°ë¡ </strong>: Firebase Functions Configë³´ë‹¤ Secret Managerê°€ í›¨ì”¬ ì•ˆì „í•˜ê³  ê´€ë¦¬í•˜ê¸° ì‰½ìŠµë‹ˆë‹¤!</p>
</div>
  </div>
</body>
</html>
